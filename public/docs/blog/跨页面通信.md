---
slug: 跨页面通信
title: 跨页面通信
excerpt: 
date: 2025-12-18
author: 小菜权
readTime: 1 分钟
tags: []
category: blog
image: https://picsum.photos/seed/689/1200/600
---

## 跨页面通信技术详解

在 Web 开发中，经常需要在不同的页面或标签页之间进行数据通信。本文将介绍几种常用的跨页面通信方案，帮助开发者选择合适的技术实现页面间的数据共享和同步。

### 1. LocalStorage 事件

LocalStorage 的 `storage` 事件可以在同源的不同标签页之间进行通信：

```javascript
// 页面 A - 发送消息
localStorage.setItem('message', JSON.stringify({
  type: 'update',
  data: { count: 10 }
}));

// 页面 B - 接收消息
window.addEventListener('storage', (e) => {
  if (e.key === 'message') {
    const message = JSON.parse(e.newValue);
    console.log('收到消息:', message);
  }
});
```

**优点**: 简单易用，浏览器原生支持  
**缺点**: 只能传递字符串，需要手动序列化；不能在同一页面内通信

### 2. BroadcastChannel API

BroadcastChannel 是专门用于跨页面通信的 API，提供了更优雅的解决方案：

```javascript
// 创建频道
const channel = new BroadcastChannel('my-channel');

// 发送消息
channel.postMessage({
  type: 'update',
  data: { count: 10 }
});

// 接收消息
channel.onmessage = (event) => {
  console.log('收到消息:', event.data);
};

// 关闭频道
channel.close();
```

**优点**: API 简洁，支持对象传递，性能好  
**缺点**: 浏览器兼容性需要考虑（IE 不支持）

### 3. SharedWorker

SharedWorker 可以在多个页面之间共享，实现跨页面通信：

```javascript
// worker.js
let ports = [];

self.onconnect = (e) => {
  const port = e.ports[0];
  ports.push(port);

  port.onmessage = (event) => {
    // 广播给所有连接的页面
    ports.forEach(p => {
      if (p !== port) {
        p.postMessage(event.data);
      }
    });
  };
};

// 页面中使用
const worker = new SharedWorker('worker.js');
worker.port.onmessage = (e) => {
  console.log('收到消息:', e.data);
};
worker.port.postMessage({ type: 'hello' });
```

**优点**: 功能强大，可以实现复杂的通信逻辑  
**缺点**: 实现相对复杂，需要额外的 worker 文件

### 4. PostMessage API

PostMessage 主要用于跨域通信，也可以用于同源的 iframe 通信：

```javascript
// 父页面
const iframe = document.querySelector('iframe');
iframe.contentWindow.postMessage({
  type: 'update',
  data: { count: 10 }
}, 'https://example.com');

// iframe 页面
window.addEventListener('message', (event) => {
  // 验证来源
  if (event.origin !== 'https://example.com') {
    return;
  }
  console.log('收到消息:', event.data);
});
```

**优点**: 支持跨域通信，安全性好  
**缺点**: 主要用于 iframe 通信，需要验证来源

### 5. IndexedDB 轮询

通过 IndexedDB 存储数据，其他页面轮询检查变化：

```javascript
// 页面 A - 写入数据
const db = await openDB('my-db', 1);
await db.put('store', { id: 1, data: 'value' }, 1);

// 页面 B - 轮询检查
setInterval(async () => {
  const db = await openDB('my-db', 1);
  const data = await db.get('store', 1);
  if (data && data.timestamp !== lastTimestamp) {
    console.log('数据更新:', data);
    lastTimestamp = data.timestamp;
  }
}, 1000);
```

**优点**: 可以存储大量数据  
**缺点**: 需要轮询，实时性较差，性能开销大

### 6. Service Worker 消息传递

通过 Service Worker 作为中间层进行消息传递：

```javascript
// 页面发送消息给 Service Worker
navigator.serviceWorker.controller.postMessage({
  type: 'broadcast',
  data: { count: 10 }
});

// Service Worker 接收并广播
self.addEventListener('message', (event) => {
  if (event.data.type === 'broadcast') {
    // 广播给所有客户端
    self.clients.matchAll().then(clients => {
      clients.forEach(client => {
        client.postMessage(event.data.data);
      });
    });
  }
});
```

**优点**: 功能强大，可以实现复杂的消息路由  
**缺点**: 需要 Service Worker 支持，实现相对复杂

### 方案选择建议

| 场景 | 推荐方案 | 原因 |
|------|---------|------|
| 简单数据同步 | LocalStorage 事件 | 简单直接 |
| 现代浏览器应用 | BroadcastChannel | API 优雅，性能好 |
| 复杂通信逻辑 | SharedWorker | 功能强大，灵活 |
| iframe 通信 | PostMessage | 标准方案 |
| 大量数据存储 | IndexedDB | 存储容量大 |
| PWA 应用 | Service Worker | 与 PWA 集成好 |

### 实际应用示例

#### 购物车同步

```javascript
// 使用 BroadcastChannel 实现购物车同步
const cartChannel = new BroadcastChannel('cart');

// 添加商品
function addToCart(product) {
  const cart = getCart();
  cart.push(product);
  saveCart(cart);
  
  // 通知其他页面
  cartChannel.postMessage({
    type: 'cart-updated',
    cart: cart
  });
}

// 监听购物车更新
cartChannel.onmessage = (event) => {
  if (event.data.type === 'cart-updated') {
    updateCartUI(event.data.cart);
  }
};
```

#### 用户状态同步

```javascript
// 使用 LocalStorage 同步登录状态
function login(user) {
  localStorage.setItem('user', JSON.stringify(user));
  localStorage.setItem('login-event', Date.now().toString());
}

window.addEventListener('storage', (e) => {
  if (e.key === 'login-event') {
    const user = JSON.parse(localStorage.getItem('user'));
    updateUserUI(user);
  }
});
```

### 注意事项

1. **数据格式**: 统一消息格式，便于维护和扩展
2. **错误处理**: 实现完善的错误处理机制
3. **性能优化**: 避免频繁通信，考虑批量处理
4. **安全性**: 验证消息来源，防止恶意数据
5. **兼容性**: 考虑浏览器兼容性，提供降级方案

跨页面通信是现代 Web 应用中的重要功能，选择合适的方案可以提升用户体验和应用性能。根据具体需求选择合适的技术方案，能够更好地实现页面间的数据同步和状态共享。
